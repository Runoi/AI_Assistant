import asyncio
import logging
from typing import Optional
from pyrogram import filters
from pyrogram.types import Message
from pyrogram.client import Client
from pyrogram import enums
from service.chatai import TerraChatAI
from service.knowledge_base import KnowledgeBase
from utils.config import Config
from pyrogram.enums import ChatType

logger = logging.getLogger(__name__)

async def mark_as_read(client: Client, message: Message):
    """–ü–æ–º–µ—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ"""
    try:
        await client.read_chat_history(message.chat.id)
        # –ò–ª–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è API):
        # await client.view_messages(message.chat.id, message.id)
    except Exception as e:
        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–º–µ—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ: {e}")

def register_handlers(app: Client, config: Config):
    chat_ai = TerraChatAI(config,client=app)
    kb = KnowledgeBase(config,app)

    @app.on_message(filters.command("start"))
    async def start(client: Client, message: Message):
        await mark_as_read(client, message)
        await message.reply("ü§ñ –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç TERRA. –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞—Ö –∏–ª–∏ –∑–∞—è–≤–∫–∞—Ö.")

    @app.on_message(filters.command("update") & filters.user(config.ADMINS))
    async def update(client: Client, message: Message):
        await mark_as_read(client, message)
        kb = KnowledgeBase(config,client=client)
        try:
            await kb.update_all_sources(
                bot=client,
                chat_id=message.chat.id,
                telegram_days_offset=config.DAYS_OFFSET,
            )
        except Exception as e:
            await message.reply(f"‚ö†Ô∏è –û—à–∏–±–∫–∞: {str(e)[:400]}")
        finally:
            await kb.close()

    @app.on_message(filters.command("update_llm") & filters.user(config.ADMINS))
    async def update_with_llm(client: Client, message: Message):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LLM-—Ä–∞–∑–º–µ—Ç–∫–∏"""
        try:
            kb = KnowledgeBase(config, client=client)
            count = await kb.update_from_telegram(days_offset=30)
            
            await message.reply(
                f"üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–æ —Å LLM-—Ä–∞–∑–º–µ—Ç–∫–æ–π\n"
                f"‚Ä¢ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: {count}\n"
                f"‚Ä¢ –ò—Å—Ç–æ—á–Ω–∏–∫–∏: Telegram"
            )
        except Exception as e:
            logger.error(f"LLM update failed: {e}")
            await message.reply(f"‚ö†Ô∏è –û—à–∏–±–∫–∞: {str(e)[:200]}")

    @app.on_message(filters.command("kb_stats") & filters.user(config.ADMINS))
    async def kb_stats_handler(client: Client, message: Message):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏"""
        def truncate_example(text: str, max_length: int = 80) -> str:
            """–û–±—Ä–µ–∑–∞–µ—Ç –ø—Ä–∏–º–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–µ (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)"""
            text = text.replace('\n', ' ')
            if len(text) > max_length:
                return text[:max_length]
            return text

        try:
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
            sources = await kb.get_all_sources()
            if not sources:
                await message.reply("üì≠ –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø—É—Å—Ç–∞")
                return

            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—ã–π –æ—Ç–≤–µ—Ç —Å Markdown-—Ä–∞–∑–º–µ—Ç–∫–æ–π
            response = [
                "üìö <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π</b>",
                "",
                f"<b>–í—Å–µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:</b> {len(sources)}",
                f"<b>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π:</b> {sum(src['count'] for src in sources)}",
                ""
            ]

            # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∫–∞–∂–¥–æ–º—É –∏—Å—Ç–æ—á–Ω–∏–∫—É
            for src in sorted(sources, key=lambda x: x['count'], reverse=True):
                response.extend([
                    "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
                    f"üîπ <b>{src['source'].upper()}</b> [<code>{src['count']}</code>]",
                    ""
                ])
                
                # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä—ã (–ø–µ—Ä–≤—ã–µ 3 –∏–∑ 5)
                for example in src['examples'][:5]:
                    response.append(f"‚ñ™Ô∏è {truncate_example(example)}")  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
                
                response.append("")

            # –†–∞–∑–±–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ
            message_text = "\n".join(response)
            if len(message_text) > 4000:
                parts = [message_text[i:i+4000] for i in range(0, len(message_text), 4000)]
                for part in parts:
                    await message.reply(part)
                    await asyncio.sleep(1)  # –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
            else:
                await message.reply(message_text)

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ kb_stats: {e}", exc_info=True)
            await message.reply("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –ª–æ–≥–∞—Ö.")

    @app.on_message(
        filters.text 
        & ~filters.command("start") 
        & ~filters.command("update")
    )
    async def handle_question(client: Client, message: Message):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å –ø–æ–ª–Ω–æ–π –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø—É—Å—Ç—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        try:
            # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∞—Ç–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if message.chat.id != -1001945870336:
                return

            if not message.from_user or not message.text:
                await _safe_reply(message, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å")
                return
            await mark_as_read(client, message)
            # 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–∞
            user_id = message.from_user.id
            question = message.text.strip()
            
            if len(question) < 2:
                await _safe_reply(message, "–í–æ–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π")
                return

            logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ –æ—Ç {user_id}: {question[:100]}...")

            # 3. –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è "–ø–µ—á–∞—Ç–∞–µ—Ç"
            await client.send_chat_action(message.chat.id, enums.ChatAction.TYPING)
            await asyncio.sleep(5)  # –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –ø–µ—á–∞—Ç–∏

            # 4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
            try:
                answer = await asyncio.wait_for(
                    chat_ai.generate_answer(user_id, question),
                    timeout=20.0
                )
                answer = _validate_message(answer)
            except asyncio.TimeoutError:
                logger.warning(f"–¢–∞–π–º–∞—É—Ç –¥–ª—è {user_id}")
                answer = "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É—Å–ø–µ–ª –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}")
                answer = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–æ–ø—Ä–æ—Å–∞"

            # 5. –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞
            await _safe_reply(message, answer)
            logger.info(f"–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")

        except Exception as e:
            logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}", exc_info=True)
            await _safe_reply(message, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞")

    async def _safe_reply(message: Message, text: str) -> bool:
        """–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –≤—Å–µ—Ö –æ—à–∏–±–æ–∫"""
        try:
            text = _validate_message(text)
            if not text:
                return False
                
            await message.reply(text)
            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            return False

    def _validate_message(text: Optional[str]) -> str:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        if not text:
            return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç"
            
        # –£–¥–∞–ª—è–µ–º –Ω–µ–ø–µ—á–∞—Ç–∞–µ–º—ã–µ —Å–∏–º–≤–æ–ª—ã
        cleaned = "".join(c for c in str(text) if c.isprintable() or c in "\n\r\t")
        cleaned = cleaned.strip()
        
        # –ó–∞–º–µ–Ω—è–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        if not cleaned:
            return "–û—Ç–≤–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–∞"
            
        # –û–±—Ä–µ–∑–∞–µ–º —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        return cleaned[:4000]


    